name: Simple PHP CI/CD

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'

    - name: Validate PHP version
      run: php -v

    - name: Install Composer (if needed)
      run: |
        if [ -f "composer.json" ]; then
          composer install --prefer-dist --no-progress --no-suggest
        fi

    - name: Validate PHP syntax
      run: |
        find . -name "*.php" -print0 | xargs -0 -n 1 php -l

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main' && success()

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up SSH key
      uses: webfactory/ssh-agent@v0.5.4
      with:
        ssh-private-key: ${{ -----BEGIN RSA PRIVATE KEY-----
MIIEowIBAAKCAQEAqQfEWJKAl/W92Z2xg89OpMCMNDNCi6L+CAEE6J1YtQvkqyLM
HL+nyqq43nyHWEptxrf1nmbfdChUjJyWYGVFLqmKdyz7LOzDBt0MZSDz8YBpXzs2
OPECFAhJq4uMtTIjuk8QxD9qboZ7B7fQRK9ljNvsIXJRgg5ux5+rXuU0U1suAiQ3
mp8Skp+hAI8BE8AgQslA26WI8Y8jHUcYeKw6RWR/1gDxlWce9Na0+k/ctveGbEyJ
HNYqAK3e7YdkdpXPOuv7d5/z500WNR5PGkJobu1zJANj+MkiVOoy5NtR2g2g+Rm7
R6z4l1UEoLTvFb7H9o63jD/h6wMDLvq9cFs0OwIDAQABAoIBAAjr2wYdvWHH25xX
wV3GnEz/yKacqf96u9OqUhsA6wSrOwd5T7KYvv9oYVeE1RPo4cBiRzl0Dokv8750
KU+vKKac1i0SF7O4T1bWZegUhCuT7nvTQTpiJgzunwzJ0cRigBY+RBFHk5N/z5CJ
uBlX9JEprl3ZjcnCf0BUAhSBHnDjwhqvjNv3fVM2vAeM9AE+SnmHZPykC+Rfd2yf
o46S2oZh++7xX6madsedYNr4uDmDNWSIHo5J/6mxBmNomP9tqWvL72w/mk2sf8YF
pQAO1hNlpTsRt9Lpfn0AH5f4JWesTLsaL1K+XgA1SVUEEnUpk2ClZe5QQj2K790U
U1Ke9fECgYEA3VZWnd0pzdPcdJKp3OtzWmWdF+wlTrN9RQb9+9sgkslgxMZnp2HD
nOlB/4i/HHyGWb6ZWCfphog/uvU2xZ+1Eu/DgyT/3iPUbZfFu7HGVnLWO1Qqzcuw
Ura2Uk6oUhhVNkR0eu66MyRznZo+JhhltWrBl3KCwIxU+T841zjN0kMCgYEAw4Bi
isB3d5yjs4zVHS+a38feCpbCuRB0BQJyP3VT6uPQDGc0JcpjKkOFR6lAlW70/jg1
Xjh0TViOG1pOEvV4GMWeNBJ0+G9pKFEosJcMhw0PQKPjU3JYudKOa93JNhfjwbYh
x0XNfT8gWEZg6st2fQei5ad0HZwrO75z7+qPoqkCgYABOB2IBxTY3mbjeX9YCS/8
enzQCev2sARroes6PO3EATn4O4OMp3w1XA+SAcXTuVfgHK2pj6a4p/154SnpEsUj
kpCII2cJaTcdV22uZ/9IsJ8/emo18f5JploAwBArS5kEkIH3v2LlLzk30AaxnQbK
Zgkk9WuE9gDt0oxUmyp/EwKBgEZfpZk6tQZ6fTb5wBE0fLSHNrdrE4cYlBrliYis
TFvmS5LbZ5se4llpWsWz+EqSWWBVjWhwO/VHpkfUVvxeHjAUmuE1r6NqP1lC9bmz
dc/7dH0ZQZBdPfEOCTRs7qwpJ1Qooroft1uZaKQ+GU8LlIhnQk0W3SZ3e9ySrxsy
vSeZAoGBAJEItNY8ylcAZ9nuUT9kbqUtFZf8mvYva3Z2TzSathw6dP9y/fLTtwWr
JXGEfj0KWJdHrq2J7U40XDU33dlzoZ7uCdmhHBd8SR6QkhiRoj91HlKCN3owXk8c
V6VIYkclqwIlGp70PA7bKRTc5m8XdLIKHuN09RhZN3trXm9tD0Yy
-----END RSA PRIVATE KEY----- }}

    - name: Deploy to EC2
      run: |
        rsync -avz --exclude='.git*' --exclude='node_modules' --exclude='.github' ./ ubuntu@ec2-54-166-29-223.compute-1.amazonaws.com:/var/www/html/your-app-directory
        ssh -o StrictHostKeyChecking=no ubuntu@ec2-54-166-29-223.compute-1.amazonaws.com << 'EOF'
          cd /var/www/html/your-app-directory
          composer install --prefer-dist --no-progress --no-suggest
          php artisan migrate --force
          php artisan cache:clear
          php artisan config:cache
          sudo systemctl restart apache2  # or nginx if you're using nginx
        EOF
